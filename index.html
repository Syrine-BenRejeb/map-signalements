<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // 1) Map Leaflet
  var map = L.map('map').setView([36.8065, 10.1815], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // 2) Helper: format date
  function formatDate(d){
    try{
      if (d && typeof d.toDate === "function") {
        return d.toDate().toLocaleDateString("fr-FR");
      }
      return d ?? "";
    }catch(e){
      return "";
    }
  }

  // 3) Fonction globale pour bouton popup
  window.openDetails = function(id){
    window.location.href = "ff://signalement?id=" + id;
  };
</script>

<!-- ✅ Firestore (Firebase Web SDK) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ✅ COLLE ICI ta config Firebase copiée depuis FlutterFlow
  const firebaseConfig = {
  apiKey: "AIzaSyAaPvnFtMPUKEy9TXfy9sw9ollnxm820m8",
  authDomain: "smartcity-f2401.firebaseapp.com",
  projectId: "smartcity-f2401",
  storageBucket: "smartcity-f2401.firebasestorage.app",
  messagingSenderId: "113851035276",
  appId: "1:113851035276:web:1535cc7a244369ebedd5a9"
};


  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ✅ Lire tous les signalements
  const colRef = collection(db, "signalements");
  const snap = await getDocs(colRef);

  snap.forEach((docSnap) => {
    const s = docSnap.data();
    const id = docSnap.id;

    if (typeof s.lat !== "number" || typeof s.lng !== "number") return;

    const marker = L.marker([s.lat, s.lng]).addTo(map);

    marker.bindPopup(`
      <b>${s.title ?? ""}</b><br/>
      Statut : ${s.statut ?? ""}<br/>
      Date : ${formatDate(s.date)}<br/>
      <button onclick="openDetails('${id}')">Voir détails</button>
    `);
  });
</script>
