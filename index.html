<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte Signalements</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .popup-title { font-weight: 700; font-size: 16px; margin: 0 0 6px; }
    .badge { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; }
    .badge-red { background:#ffebee; color:#c62828; }
    .badge-green { background:#e8f5e9; color:#2e7d32; }
    .meta { font-size: 12px; color: #555; margin-top: 6px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Web SDK v9) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ✅ 1) REMPLACE PAR TA CONFIG FIREBASE
    const firebaseConfig = {
  apiKey: "AIzaSyAaPvnFtMPUKEy9TXfy9sw9ollnxm820m8",
  authDomain: "smartcity-f2401.firebaseapp.com",
  projectId: "smartcity-f2401",
  storageBucket: "smartcity-f2401.firebasestorage.app",
  messagingSenderId: "113851035276",
  appId: "1:113851035276:web:1535cc7a244369ebedd5a9"
};


    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ✅ Init Leaflet map (centre Tunis)
    const map = L.map('map').setView([36.8065, 10.1815], 11);

    // Tiles OSM (gratuit)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Groupe de markers pour nettoyer/rafraîchir
    const markersLayer = L.layerGroup().addTo(map);

    function formatDate(ts) {
      try {
        // Firestore Timestamp -> Date
        const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        if (!d) return "";
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      } catch { return ""; }
    }

    function statusBadge(status, isResolved) {
      const resolved = (isResolved === true) || (String(status).toLowerCase().includes("résolu"));
      if (resolved) return `<span class="badge badge-green">Résolu</span>`;
      return `<span class="badge badge-red">Non résolu</span>`;
    }

    function addSignalementMarker(docId, data) {
      const lat = Number(data.latitude);
      const lng = Number(data.longitude);

      // Ignore coords invalides
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
      if (lat < -90 || lat > 90 || lng < -180 || lng > 180) return;

      // ✅ Boule bleue (circleMarker)
      const m = L.circleMarker([lat, lng], {
        radius: 8,
        color: "#1E88E5",
        fillColor: "#1E88E5",
        fillOpacity: 0.9,
        weight: 2
      });

      const title = data.title ?? "Sans titre";
      const status = data.status ?? "";
      const category = data.category ?? "";
      const community = data.community ?? "";
      const dateStr = formatDate(data.createdAt);

      const popupHtml = `
        <div>
          <div class="popup-title">${title}</div>
          <div>${statusBadge(status, data.isResolved)}</div>
          <div class="meta">
            ${category ? `Catégorie: <b>${category}</b><br>` : ""}
            ${community ? `Communauté: <b>${community}</b><br>` : ""}
            ${dateStr ? `Date: <b>${dateStr}</b>` : ""}
          </div>
        </div>
      `;

      m.bindPopup(popupHtml);
      m.addTo(markersLayer);
    }

    async function loadSignalements() {
      markersLayer.clearLayers();

      // ✅ 2) Récupérer Firestore
      const q = query(collection(db, "signalements"), orderBy("createdAt", "desc"));
      const snap = await getDocs(q);

      snap.forEach((doc) => addSignalementMarker(doc.id, doc.data()));
    }

    // Lancer au chargement
    loadSignalements();
  </script>
</body>
</html>
