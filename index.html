<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte des signalements</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }

    .popup-title {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 6px;
    }

    .meta {
      font-size: 12px;
      margin-top: 8px;
      color: #444;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // üî¥ REMPLACE PAR TON firebaseConfig
    const firebaseConfig = {
  apiKey: "AIzaSyAaPvnFtMPUKEy9TXfy9sw9ollnxm820m8",
  authDomain: "smartcity-f2401.firebaseapp.com",
  projectId: "smartcity-f2401",
  storageBucket: "smartcity-f2401.firebasestorage.app",
  messagingSenderId: "113851035276",
  appId: "1:113851035276:web:1535cc7a244369ebedd5a9"
};


    // ================= MAP =================
    const map = L.map("map").setView([36.8065, 10.1815], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);

    // ================= HELPERS =================
    function toNumber(v) {
      const n = parseFloat(String(v ?? "").replace(",", "."));
      return Number.isFinite(n) ? n : null;
    }

    function inTunisia(lat, lng) {
      return lat >= 30 && lat <= 38 && lng >= 6 && lng <= 12;
    }

    function fixLatLng(lat, lng) {
      if (lat == null || lng == null) return [null, null];
      if (inTunisia(lat, lng)) return [lat, lng];
      if (inTunisia(lng, lat)) return [lng, lat];
      return [lat, lng];
    }

    function getLatLng(data) {
      let lat = toNumber(data.latitude);
      let lng = toNumber(data.longitude);

      if (lat == null || lng == null) {
        lat = toNumber(data.lat);
        lng = toNumber(data.lng);
      }

      if ((lat == null || lng == null) && data.location) {
        lat = toNumber(data.location.latitude);
        lng = toNumber(data.location.longitude);
      }

      return fixLatLng(lat, lng);
    }

    function formatDate(ts) {
      try {
        const d = ts?.toDate ? ts.toDate() : null;
        if (!d) return "";
        return d.toLocaleDateString("fr-FR");
      } catch {
        return "";
      }
    }

    // ================= MAIN =================
    async function loadSignalements() {
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const snap = await getDocs(collection(db, "signalements"));

      let bounds = [];

      snap.forEach((doc) => {
        const data = doc.data();
        let [lat, lng] = getLatLng(data);

        if (lat == null || lng == null) return;
        if (lat === 0 || lng === 0) return;

        const popup = `
          <div>
            <div class="popup-title">${data.title ?? "Sans titre"}</div>
            <div class="meta">
              ${
                data.status && data.status !== "R√©solu"
                  ? `Statut : <b>${data.status}</b><br>`
                  : ""
              }
              ${data.category ? `Cat√©gorie : <b>${data.category}</b><br>` : ""}
              ${data.community ? `Communaut√© : <b>${data.community}</b><br>` : ""}
              ${data.createdAt ? `Date : <b>${formatDate(data.createdAt)}</b>` : ""}
            </div>
          </div>
        `;

        L.circleMarker([lat, lng], {
          radius: 8,
          color: "#1E88E5",
          fillColor: "#1E88E5",
          fillOpacity: 0.9,
          weight: 2
        })
          .addTo(markersLayer)
          .bindPopup(popup);

        bounds.push([lat, lng]);
      });

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [40, 40] });
      }
    }

    loadSignalements();
  </script>
</body>
</html>
