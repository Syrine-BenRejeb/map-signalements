<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte des signalements</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #f3f4f6;
    }
    #map {
      height: 100vh;        /* IMPORTANT: full height */
      width: 100vw;
    }

    /* Bottom card */
    #card {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      overflow: hidden;
      display: none;        /* hidden until click */
      z-index: 9999;
      font-family: Arial, sans-serif;
    }

    #cardHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 12px 8px 12px;
      gap: 12px;
    }
    #cardTitle {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      line-height: 1.2;
      color: #111827;
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #closeBtn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: none;
      background: #16a34a;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    #cardImage {
      width: 100%;
      height: 150px;
      object-fit: cover;
      background: #e5e7eb;
      display: none;
    }

    #cardMeta {
      display: flex;
      justify-content: space-between;
      padding: 10px 12px;
      font-size: 14px;
      color: #111827;
    }
    #statusText { color: #111827; }
    #dateText { color: #111827; }

    #cardFooter {
      padding: 0 12px 12px 12px;
    }
    #detailsBtn {
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 12px;
      background: #065f46;
      color: white;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Bottom card -->
  <div id="card">
    <div id="cardHeader">
      <h3 id="cardTitle">—</h3>
      <button id="closeBtn">×</button>
    </div>
    <img id="cardImage" alt="image signalement" />
    <div id="cardMeta">
      <div id="statusText">—</div>
      <div id="dateText">—</div>
    </div>
    <div id="cardFooter">
      <button id="detailsBtn">Voir détails</button>
    </div>
  </div>

  <!-- Firebase (Web SDK v9) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ✅ 1) Mets TON firebaseConfig ici
    const firebaseConfig = {
  apiKey: "AIzaSyAaPvnFtMPUKEy9TXfy9sw9ollnxm820m8",
  authDomain: "smartcity-f2401.firebaseapp.com",
  projectId: "smartcity-f2401",
  storageBucket: "smartcity-f2401.firebasestorage.app",
  messagingSenderId: "113851035276",
  appId: "1:113851035276:web:1535cc7a244369ebedd5a9"
};

    // -------- Helpers --------
    function parseCoord(v) {
      if (v === null || v === undefined) return null;
      if (typeof v === "number") return v;
      if (typeof v === "string") {
        const cleaned = v.trim().replace(",", ".");
        const n = Number(cleaned);
        return Number.isFinite(n) ? n : null;
      }
      return null;
    }

    function inTunisia(lat, lng) {
      // Box simple Tunisie (assez strict pour éviter mer/Afrique)
      return lat >= 30.0 && lat <= 37.6 && lng >= 7.0 && lng <= 12.5;
    }

    function formatDate(ts) {
      try {
        // Firestore Timestamp -> ts.toDate()
        const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        if (!d) return "—";
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      } catch {
        return "—";
      }
    }

    // ✅ 2) Init map (tap:false important WebView)
    const map = L.map("map", { tap: false, zoomControl: true });

    // Base center Tunis
    map.setView([36.8065, 10.1815], 6);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    // ✅ 3) Fix “points appear only after zoom”
    //    -> invalidateSize plusieurs fois (WebView timing)
    function forceResizeFix() {
      requestAnimationFrame(() => map.invalidateSize(true));
      setTimeout(() => map.invalidateSize(true), 200);
      setTimeout(() => map.invalidateSize(true), 600);
      setTimeout(() => map.invalidateSize(true), 1200);
    }
    window.addEventListener("load", forceResizeFix);
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) forceResizeFix();
    });

    // Bottom card elements
    const card = document.getElementById("card");
    const cardTitle = document.getElementById("cardTitle");
    const cardImage = document.getElementById("cardImage");
    const statusText = document.getElementById("statusText");
    const dateText = document.getElementById("dateText");
    const closeBtn = document.getElementById("closeBtn");
    const detailsBtn = document.getElementById("detailsBtn");

    let selectedId = null;

    function openCard(data) {
      selectedId = data.id;

      cardTitle.textContent = data.title || "Sans titre";
      statusText.textContent = data.status || "—";
      dateText.textContent = formatDate(data.createdAt);

      if (data.imageUrl) {
        cardImage.src = data.imageUrl;
        cardImage.style.display = "block";
      } else {
        cardImage.style.display = "none";
      }

      card.style.display = "block";
    }

    function closeCard() {
      card.style.display = "none";
      selectedId = null;
    }

    closeBtn.addEventListener("click", closeCard);

    detailsBtn.addEventListener("click", () => {
      if (!selectedId) return;
      // ✅ Deep link FlutterFlow
      window.location.href = `ff://signalement?id=${encodeURIComponent(selectedId)}`;
    });

    // ✅ 4) Load Firestore and render circleMarkers (always clickable)
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const markers = [];

    async function loadSignalements() {
      const snap = await getDocs(collection(db, "signalements"));

      snap.forEach(doc => {
        const d = doc.data();
        const id = doc.id;

        let lat = parseCoord(d.latitude);
        let lng = parseCoord(d.longitude);

        if (lat === null || lng === null) return;

        // ✅ inversion auto si besoin (ex: lat=10.xx lng=36.xx)
        if (Math.abs(lat) < 20 && Math.abs(lng) > 20) {
          const tmp = lat; lat = lng; lng = tmp;
        }

        // ✅ filtre Tunisie
        if (!inTunisia(lat, lng)) return;

        const data = {
          id,
          title: d.title || "",
          status: d.status || "",
          createdAt: d.createdAt,
          imageUrl: d.imageUrl || "",
          lat,
          lng
        };

        const m = L.circleMarker([lat, lng], {
          radius: 8,
          weight: 2,
          color: "#b91c1c",
          fillColor: "#ef4444",
          fillOpacity: 0.95
        }).addTo(map);

        // ✅ click marker -> open card + center map
        m.on("click", () => {
          openCard(data);
          map.setView([lat, lng], Math.max(map.getZoom(), 15), { animate: true });
          forceResizeFix(); // garde cliquable même si WebView bouge
        });

        markers.push(m);
      });

      // ✅ Fit bounds to show points immediately (no zoom needed)
      if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      } else {
        map.setView([36.8065, 10.1815], 6);
      }

      forceResizeFix(); // encore une fois après ajout markers
    }

    loadSignalements();
  </script>
</body>
</html>
