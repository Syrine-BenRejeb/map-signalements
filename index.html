<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // ðŸ”µ MAP
  var map = L.map('map').setView([36.8065, 10.1815], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ðŸ”µ FORMAT DATE
  function formatDate(d){
    try{
      if (d && typeof d.toDate === "function") {
        return d.toDate().toLocaleDateString("fr-FR");
      }
      return "";
    }catch(e){
      return "";
    }
  }

  // ðŸ”µ OUVRIR DETAILS (FlutterFlow)
  window.openDetails = function(id){
    window.location.href = "ff://signalement?id=" + id;
  };
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // âš ï¸ COLLE TA CONFIG FIREBASE ICI
  const firebaseConfig = {
  apiKey: "AIzaSyAaPvnFtMPUKEy9TXfy9sw9ollnxm820m8",
  authDomain: "smartcity-f2401.firebaseapp.com",
  projectId: "smartcity-f2401",
  storageBucket: "smartcity-f2401.firebasestorage.app",
  messagingSenderId: "113851035276",
  appId: "1:113851035276:web:1535cc7a244369ebedd5a9"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ðŸ”¥ LECTURE DES SIGNALEMENTS
  const snapshot = await getDocs(collection(db, "signalements"));

  snapshot.forEach((docSnap) => {
    const s = docSnap.data();
    const id = docSnap.id;

    if (typeof s.latitude !== "number" || typeof s.longitude !== "number") return;

    const marker = L.marker([s.latitude, s.longitude]).addTo(map);

    marker.bindPopup(`
      <b>${s.title ?? ""}</b><br/>
      Statut : ${s.status ?? ""}<br/>
      Date : ${formatDate(s.createdAt)}<br/>
      <button onclick="openDetails('${id}')">Voir dÃ©tails</button>
    `);
  });
</script>
